<!DOCTYPE html>
<html>
<head>
<title>WebSocket test</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r70/three.min.js"></script>
</head>
<body>
This sends simulated sensor data in 
<div>
<label>WebSocket URL: <input id="ws-url" value="ws://localhost:8080/ws"></label>
<button id="connect">Connect</button>
</div>

<div id="3d" style="display: none;"></div>
<div id="2d"></div>
<script>
// Handle sockets
var ws;
var socketsOpen = 0;
function startSending() {
    function onOpen() {
        socketsOpen += 1;
    }
    function onMessage(event) {
        console.log(event.data);
    }
    if (!socketsOpen) {
        var url = document.getElementById('ws-url').value;
        ws = new WebSocket(url);
        ws.binaryType = 'arraybuffer';
        
        ws.onopen = onOpen;

        ws.onmessage = onMessage;
    }
}

function send() {
    if (socketsOpen === 1) {
        ws.send('sensor');
        ws.send(JSON.stringify(sensorData));
        ws.send('camera');
        ws.send(imageData.data.buffer);
    }
}

document.getElementById('connect').addEventListener('click', function () {
    startSending();
});

var sensorData = {
  "speed": 1.7,
  "angularVelocity": 1.3,
  "odometer": 6.2327614434364,
  "compass": 120.08452439086,
  "arms": {
    "left": {
      "held": "portable_table"
    },
    "right": {
      "held": null
    }
  },
  "camera": {
    "width": 320,
    "height": 240
  },
  "collision": {
    "front": false,
    "back": true,
    "left": false,
    "right": false,
    "top": false,
    "bottom": true
  },
  "keys": [
    "A",
    "W"
  ]
};

var canvas = document.createElement('canvas'),
    ctx = canvas.getContext('2d'),
    imageData = ctx.createImageData(320, 240);
canvas.width = 320;
canvas.height = 240;
document.getElementById('2d').appendChild(canvas);

// Setup rendering
var scene = new THREE.Scene();
var camera = new THREE.PerspectiveCamera(45, 320/240, 0.1, 100);
var renderer = new THREE.WebGLRenderer({antialias: true});
renderer.setSize(320, 240);
var container = document.getElementById("3d");
container.appendChild(renderer.domElement);
var gl = renderer.getContext();

// Setup scene
var light = new THREE.PointLight(0xffffff);
light.position.set(100,250,100);
scene.add(light);
var cube = new THREE.Mesh(
    new THREE.BoxGeometry(1,1,1),
    new THREE.MeshLambertMaterial({color: 0x9999ff})
    );
cube.position.set(0,-1,-5);
scene.add(cube);

// This flips the rendered scene
var cameraData;
var getImageData = (function () {
    var arraySize, i, intView,
        rowView1, rowView2, tempRow, rows, cols;

    return function () {
        if (!arraySize) {
            rows = 240;
            cols = 320;

            arraySize = rows * cols * 4;

            cameraData = new Uint8Array(arraySize);

            intView = new Uint32Array(cameraData.buffer);

            tempRow = new Uint32Array(cols);
        }

        gl.readPixels(0, 0,
            cols, rows, gl.RGBA,
            gl.UNSIGNED_BYTE, cameraData);

        // Flip the image data
        for (i = 0; i < rows / 2; i += 1) {
            rowView1 = intView.subarray(i * cols,
                (i + 1) *cols);
            rowView2 = intView.subarray((rows - i - 1) * cols,
                                        (rows - i) * cols);
            tempRow.set(rowView1);
            rowView1.set(rowView2);
            rowView2.set(tempRow);
        }
    };
}());

// Animate
function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
    cube.rotation.y += 1/60;
    getImageData();
    imageData.data.set(cameraData);
    ctx.putImageData(imageData, 0, 0);
    send();
}
animate();
</script>
</body>
</html>
